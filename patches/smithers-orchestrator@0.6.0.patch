diff --git a/src/agents/cli.ts b/src/agents/cli.ts
--- a/src/agents/cli.ts
+++ b/src/agents/cli.ts
@@ -548,7 +548,12 @@
     const { prompt, systemFromMessages } = extractPrompt(options);
     const callTimeout = resolveTimeoutMs(options?.timeout, this.timeoutMs);
     const cwd = this.cwd ?? getToolContext()?.rootDir ?? process.cwd();
-    const env = { ...process.env, ...(this.env ?? {}) } as Record<
+    // Strip CLAUDE* env vars to prevent child CLI agents from detecting
+    // a nested session and exiting immediately with code 0.
+    const baseEnv = Object.fromEntries(
+      Object.entries(process.env).filter(([k]) => !k.startsWith("CLAUDE")),
+    );
+    const env = { ...baseEnv, ...(this.env ?? {}) } as Record<
       string,
       string
     >;
@@ -830,8 +835,7 @@
     let schemaCleanupFile: string | null = null;
     if (!this.opts.outputSchema && params.options?.outputSchema) {
       try {
-        const { zodToJsonSchema } = await import("zod-to-json-schema");
-        const jsonSchema = zodToJsonSchema(params.options.outputSchema);
+        const jsonSchema = params.options.outputSchema.toJSONSchema();
         const schemaFile = join(
           tmpdir(),
           `smithers-schema-${randomUUID()}.json`,
