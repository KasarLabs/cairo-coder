# Codebase Report: Cairo Coder RAG Pipeline & Test Structure
Generated: 2026-02-16

## Summary

Cairo Coder is a DSPy-based RAG (Retrieval-Augmented Generation) system for Cairo/Starknet programming assistance. The pipeline follows a **three-stage architecture**: Query Processing → Document Retrieval → Generation, with optional Grok web search augmentation and retrieval judging. Tests are organized into **unit tests** (mocked components) and **integration tests** (full pipeline with TestClient).

---

## Pipeline Flow: API Request → Response

### Entry Point: FastAPI Server

**File:** `python/src/cairo_coder/server/app.py`

**Key Endpoints:**
- `POST /v1/chat/completions` (line 394) - Legacy endpoint
- `POST /v1/agents/{agent_id}/chat/completions` (line 361) - Agent-specific endpoint
- `POST /chat/completions` (line 412) - Alternative legacy endpoint
- `POST /v1/suggestions` (line 430) - Follow-up suggestion generation
- `GET /v1/agents` (line 335) - List available agents

### Request Flow

```
1. FastAPI endpoint receives ChatCompletionRequest
   ↓
2. Extract conversation_id, user_id, mcp_mode headers
   (lines 453-459)
   ↓
3. Get or create agent via AgentFactory
   (line 473: agent_factory.get_or_create_agent())
   ↓
4. Branch: Streaming or Non-streaming?
   
   STREAMING (line 479):
   ↓
   5a. _stream_chat_completion() → agent.aforward_streaming()
       (line 508-648)
       • Emits StreamEvents (PROCESSING, SOURCES, REASONING, RESPONSE, FINAL_RESPONSE, END)
       • Logs interaction in background via log_interaction_raw() (line 626)
   
   NON-STREAMING (line 492):
   ↓
   5b. _generate_chat_completion() → agent.acall()
       (line 672-726)
       • Returns ChatCompletionResponse with usage stats
       • Logs interaction in background via log_interaction_task() (line 494)
```

---

## RAG Pipeline Architecture

**File:** `python/src/cairo_coder/core/rag_pipeline.py`

### Core Class: `RagPipeline(dspy.Module)` (line 60)

**Configuration:** `RagPipelineConfig` (line 45-57)
- `query_processor: QueryProcessorProgram`
- `document_retriever: DocumentRetrieverProgram`
- `generation_program: GenerationProgram`
- `mcp_generation_program: McpGenerationProgram`
- `sources: list[DocumentSource]`
- `max_source_count: int`
- `similarity_threshold: float`

### Pipeline Stages

#### Stage 1: Query Processing

**File:** `python/src/cairo_coder/dspy/query_processor.py`

**Entry:** `QueryProcessorProgram.aforward()` (line 129)

**Signature:** `CairoQueryAnalysis` (line 47-70)
- **Inputs:** `query: str`, `chat_history: str`
- **Outputs:** 
  - `search_queries: list[str]` (3 semantic search queries for vector store)
  - `resources: list[str]` (documentation sources to search)

**Optimized Program:** Loads `optimizers/results/optimized_retrieval_program.json` (line 86-89)

**Output:** `ProcessedQuery` (line 148-154)
```python
ProcessedQuery(
    original=query,
    search_queries=search_queries,
    is_contract_related=bool,
    is_test_related=bool,
    resources=list[DocumentSource]
)
```

**Resource Descriptions:** `RESOURCE_DESCRIPTIONS` (line 20-31) maps `DocumentSource` enums to descriptions:
- `CAIRO_BOOK` - Core language syntax, smart contracts, storage, events
- `STARKNET_DOCS` - Protocol, STWO prover, APIs, syscalls
- `STARKNET_FOUNDRY` - snforge/sncast toolchain
- `CAIRO_BY_EXAMPLE` - Practical code snippets
- `OPENZEPPELIN_DOCS` - Standard contract implementations
- `CORELIB_DOCS` - Core library, stdlib, macros
- `SCARB_DOCS` - Package manager, build tool
- `STARKNET_JS` - JavaScript/TypeScript integration
- `STARKNET_BLOG` - Latest updates, announcements
- `DOJO_DOCS` - Onchain game framework

#### Stage 2: Document Retrieval

**File:** `python/src/cairo_coder/dspy/document_retriever.py`

**Entry:** `DocumentRetrieverProgram.aforward()` (line 288)

**Vector Store:** `SourceFilteredPgVectorRM` (line 34-239)
- Extends `PgVectorRM` with source filtering
- Async forward: `aforward()` (line 63) uses asyncpg pool
- Filters by `DocumentSource` enum values (line 100-104)
- Applies similarity threshold (line 107-111): `1 - cosine_similarity < threshold`
- SQL: `SELECT * FROM {table} WHERE metadata->>'source' = ANY($1) AND embedding <=> $2 < $3 ORDER BY embedding <=> $2 LIMIT $4`

**Retrieval Process:**
1. Fetch documents for each `search_query` from `ProcessedQuery.search_queries` (line 371-377)
2. Deduplicate by converting to set (line 379-383)
3. Enhance with templates if contract/test-related (line 387-426)
   - `CONTRACT_TEMPLATE` for contract queries
   - `TEST_TEMPLATE` for test queries

**Output:** `dspy.Prediction(documents=list[Document])` (line 316)

#### Stage 2.5: Retrieval Judging (Optional)

**File:** `python/src/cairo_coder/dspy/retrieval_judge.py`

**Signature:** `RetrievalRecallPrecision` (line 32-80)
- Scores each document 0.0-1.0 for relevance to query
- Filters documents below threshold (default 0.4)
- Adds metadata: `llm_judge_score`, `llm_judge_reason`

**Execution:** `RagPipeline._aprocess_query_and_retrieve_docs()` (line 128-140)
```python
with dspy.context(lm=dspy.LM("gemini/gemini-flash-lite-latest")):
    judge_pred = await self.retrieval_judge.acall(query=query, documents=documents)
    documents = judge_pred.documents  # Filtered list
```

#### Stage 2.6: Grok Search Augmentation (Optional)

**File:** `python/src/cairo_coder/dspy/grok_search.py`

**Trigger:** When `DocumentSource.STARKNET_BLOG` in retrieval sources (line 116)

**Function:** `GrokSearchProgram.aforward()` fetches recent web/X posts about Starknet
- Adds virtual "grok-answer" document with summary (line 143-149)
- Returns citations list (URLs)

#### Stage 3: Response Generation

**File:** `python/src/cairo_coder/dspy/generation_program.py`

**Programs:**
1. **Normal Mode:** `GenerationProgram` (line 157-287)
   - Uses `CairoCodeGeneration` signature (line 23-43) or `StarknetEcosystemGeneration` (line 64-153)
   - Chain of Thought reasoning
   - Loads optimized programs: `optimizers/results/optimized_generation_{agent_id}.json` (line 192-195)
   - Streaming support: `aforward_streaming()` (line 225-257) yields `StreamResponse` chunks

2. **MCP Mode:** `McpGenerationProgram` (line 289-338)
   - Returns raw formatted documentation without LLM generation
   - Format: Numbered sections with title, source, URL, content

**Signatures:**
- `CairoCodeGeneration` (line 23): For cairo-coder agent
  - Input: `query`, `context`, `chat_history`
  - Output: `answer` (Cairo code in ```cairo blocks)
  
- `StarknetEcosystemGeneration` (line 64): For starknet-agent
  - Detailed citation rules (inline markdown links)
  - LaTeX formula support
  - Code generation best practices
  - Out-of-scope query handling

**Context Preparation:** `RagPipeline._prepare_context()` (line 442-493)
```markdown
Relevant Documentation:

## [Document Title](url)
*Source: Display Name*

{page_content}

---
```

**Output:** `dspy.Prediction(answer=str)`

#### Stage 4: Response Assembly

**File:** `python/src/cairo_coder/core/rag_pipeline.py`

**Final Prediction:** `RagPipeline.aforward()` (line 153-203)
```python
dspy.Prediction(
    processed_query=ProcessedQuery,
    documents=list[Document],
    grok_citations=list[str],
    answer=str,
    formatted_sources=list[FormattedSource]
)
```

**Formatted Sources:** `_format_sources()` (line 396-440)
```python
[
    {
        "metadata": {
            "title": str,
            "url": str,
            "source_type": "documentation" | "web_search"
        }
    }
]
```

**Usage Tracking:** DSPy's `track_usage()` captures token counts (line 232)
```python
{
    "gemini/gemini-3-flash-preview": {
        "prompt_tokens": int,
        "completion_tokens": int,
        "total_tokens": int
    }
}
```

---

## Agent Registry

**File:** `python/src/cairo_coder/agents/registry.py`

### Available Agents

**Enum:** `AgentId` (line 23-27)
```python
class AgentId(str, Enum):
    CAIRO_CODER = "cairo-coder"
    STARKNET = "starknet-agent"
```

**Registry:** `registry: dict[AgentId, AgentSpec]` (line 113-136)

#### 1. Cairo Coder Agent (line 114-124)
```python
AgentId.CAIRO_CODER: AgentSpec(
    name="Cairo Coder",
    description="General Cairo programming assistant",
    sources=list(DocumentSource),  # All sources
    pipeline_builder=RagPipelineFactory.create_pipeline,
    query_processor_factory=_create_query_processor,
    generation_program_factory=_create_cairo_coder_generation_program,
    mcp_generation_program_factory=_create_mcp_generation_program,
    max_source_count=5,
    similarity_threshold=0.65
)
```

**Generation Program:** Uses `CairoCodeGeneration` signature
- Optimized program: `optimizers/results/optimized_generation_cairo-coder.json`

#### 2. Starknet Agent (line 125-135)
```python
AgentId.STARKNET: AgentSpec(
    name="Starknet Agent",
    description="Assistant for the Starknet ecosystem (contracts, tools, docs).",
    sources=list(DocumentSource),  # All sources
    pipeline_builder=RagPipelineFactory.create_pipeline,
    query_processor_factory=_create_query_processor,
    generation_program_factory=_create_starknet_generation_program,
    mcp_generation_program_factory=_create_mcp_generation_program,
    max_source_count=5,
    similarity_threshold=0.65
)
```

**Generation Program:** Uses `StarknetEcosystemGeneration` signature
- Optimized program: `optimizers/results/optimized_generation_starknet-agent.json`
- Specialized prompts with citation rules, LaTeX support, code generation guidelines

### Agent Factory

**File:** `python/src/cairo_coder/core/agent_factory.py`

**Class:** `AgentFactory` (line 20-110)

**Key Methods:**
- `get_or_create_agent(agent_id, mcp_mode)` (line 42-71)
  - Caches agents by `{agent_id}_{mcp_mode}` key
  - Builds from `AgentSpec` via `spec.build(vector_db, config)`
  
- `get_available_agents()` (line 77-86)
  - Returns `["cairo-coder", "starknet-agent"]`
  
- `get_agent_info(agent_id)` (line 88-110)
  - Returns metadata dict with `id`, `name`, `description`, `sources`, `max_source_count`, `similarity_threshold`

**Lazy Program Creation:** Programs are NOT created at import time (line 69)
- Factory functions (`_create_cairo_coder_generation_program`, etc.) are called in `AgentSpec.build()`
- Avoids expensive DSPy initialization on module load

---

## Test Structure

**Root:** `python/tests/`

### Shared Fixtures: `conftest.py`

**Key Fixtures:**

#### Mock Components
- `mock_vector_db` (line 55-72) - Mocked `SourceFilteredPgVectorRM` with async pool
- `mock_lm` (line 86-111) - Mocked DSPy `ChainOfThought` returning sample predictions
- `mock_agent` (line 178-250) - Mocked `RagPipeline` with `acall()` and `aforward_streaming()`
- `mock_agent_factory` (line 145-174) - Mocked `AgentFactory` with agent registry integration

#### Pipeline Components
- `mock_query_processor` (line 436-445) - Returns `sample_processed_query`
- `mock_document_retriever` (line 449-458) - Returns `sample_documents`
- `mock_generation_program` (line 462-483) - Returns sample Cairo code, supports streaming
- `mock_mcp_generation_program` (line 487-513) - Returns formatted MCP documentation
- `mock_retrieval_judge` (line 517-560) - Filters docs by score threshold (0.4)

#### Configuration
- `mock_vector_store_config` (line 76-83) - PostgreSQL connection config
- `sample_documents` (line 344-388) - 4 sample docs from Cairo Book, Starknet Docs, Scarb, OpenZeppelin
- `sample_processed_query` (line 333-341) - "How do I create a Cairo contract?"

#### Integration Fixtures
- `postgres_container` (line 263-279) - Session-scoped testcontainer (Docker-based)
- `client` (line 283-325) - FastAPI `TestClient` with dependency injection
- `pipeline_config` (line 563-581) - Full `RagPipelineConfig` with mocked components
- `pipeline` (line 608-621) - Full `RagPipeline` instance with mocked judge

#### Auto-Applied Fixtures
- `optimizer_artifacts_optional` (line 43-46) - Sets `OPTIMIZER_RUN=1` to skip optimizer file loading
- `enable_dspy_track_usage` (line 36-39) - Enables DSPy token usage tracking
- `clean_config_env_vars` (line 396-433) - Cleans env vars before each test

---

### Unit Tests (Mocked Dependencies)

**Location:** `python/tests/unit/`

#### 1. `test_rag_pipeline.py` (30k file)

**Tests RAG Pipeline orchestration:**
- `test_async_pipeline_execution` - Tests `pipeline.acall()` calls all components
- `test_streaming_pipeline_execution` - Tests `pipeline.aforward_streaming()` emits correct event sequence
- `test_mcp_mode_execution` - Tests MCP mode uses `mcp_generation_program`
- `test_pipeline_with_chat_history` - Tests chat history formatting and passing
- `test_pipeline_with_custom_sources` - Tests source filtering
- `test_empty_documents_handling` - Tests pipeline behavior with no retrieved docs

**Helper Functions:**
- `create_custom_documents(specs)` (line 28-42) - Create test documents with specific metadata
- `create_custom_retrieval_judge(score_map, threshold)` (line 45-74) - Mock judge with custom scoring

#### 2. `test_query_processor.py` (6.5k file)

**Tests Query Processing:**
- Query analysis and resource identification
- Search query extraction
- Contract/test-related detection
- Resource validation and fallback logic

#### 3. `test_document_retriever.py` (12k file)

**Tests Document Retrieval:**
- Vector store search with source filtering
- Similarity threshold filtering
- Document deduplication
- Template enhancement (contract/test templates)
- Async retrieval via `aforward()`

#### 4. `test_generation_program.py` (15k file)

**Tests Generation Programs:**
- Cairo code generation with `CairoCodeGeneration` signature
- Starknet ecosystem responses with `StarknetEcosystemGeneration` signature
- Streaming generation via `aforward_streaming()`
- MCP mode formatting
- Chat history formatting
- AdapterParseError retry logic

#### 5. `test_retrieval_judge.py` (8.4k file)

**Tests Retrieval Judge:**
- Document scoring (0.0-1.0 scale)
- Threshold filtering (default 0.4)
- Metadata attachment (`llm_judge_score`, `llm_judge_reason`)
- Async judging via `acall()`

#### 6. `test_agent_factory.py` (7.9k file)

**Tests Agent Factory:**
- Agent creation from registry
- Agent caching by `{agent_id}_{mcp_mode}` key
- Available agents listing
- Agent info retrieval
- Invalid agent handling

#### 7. `test_grok_integration.py` (5.6k file)

**Tests Grok Search:**
- Web search augmentation
- Citation extraction
- Virtual document creation
- Error handling

#### 8. `test_config.py` (3.5k file)

**Tests Configuration:**
- Config loading from environment
- Vector store config validation
- Default value handling

#### 9. `test_optimizers_loading.py` (2.4k file)

**Tests Optimizer Artifacts:**
- Optimized program loading
- Missing optimizer file handling
- OPTIMIZER_RUN flag behavior

---

### Integration Tests (Full Pipeline)

**Location:** `python/tests/integration/`

#### 1. `test_server_integration.py` (31k file)

**Tests FastAPI Server:**
- `test_health_check_integration` - `GET /` returns `{"status": "ok"}`
- `test_list_agents` - `GET /v1/agents` returns cairo-coder and starknet-agent
- `test_full_agent_workflow` - Lists agents → Creates chat completion
- `test_multiple_conversation_turns` - Tests multi-turn conversations with history
- `test_streaming_integration` - Tests Server-Sent Events streaming
- `test_error_handling_integration` - Tests 400/500 error responses
- `test_agent_specific_endpoint` - Tests `POST /v1/agents/{agent_id}/chat/completions`
- `test_mcp_mode_header` - Tests `x-mcp-mode` and `mcp` headers
- `test_conversation_id_tracking` - Tests `x-conversation-id` header
- `test_user_id_hashing` - Tests `x-user-id` and `x-api-key` hashing
- `test_concurrent_requests` - Tests parallel request handling

**Setup:**
- Uses `client` fixture with `TestClient`
- Mocks `get_vector_db` and `get_agent_factory` dependencies
- Uses ephemeral PostgreSQL via `postgres_container` (Docker)

#### 2. `test_insights_api.py` (15k file)

**Tests Insights API:**
- `GET /v1/insights/queries` - Query analytics
- `GET /v1/insights/queries/top` - Top queries
- `GET /v1/insights/agents/usage` - Agent usage stats
- `GET /v1/insights/sources/popularity` - Source popularity
- Date range filtering
- Pagination
- Error handling

**Database:** Uses PostgreSQL container with `UserInteraction` table

#### 3. `test_config_integration.py` (3.2k file)

**Tests Configuration Integration:**
- Environment variable loading
- Database connection setup
- Vector store configuration

---

## Key Abstractions

### DSPy Signatures

**Purpose:** Define input/output schema for LLM calls

1. **`CairoQueryAnalysis`** (`query_processor.py:47`)
   - Input: `query`, `chat_history`
   - Output: `search_queries`, `resources`

2. **`CairoCodeGeneration`** (`generation_program.py:23`)
   - Input: `query`, `context`, `chat_history`
   - Output: `answer` (Cairo code in ```cairo blocks)

3. **`StarknetEcosystemGeneration`** (`generation_program.py:64`)
   - Input: `query`, `context`, `chat_history`
   - Output: `answer` (with citation rules, LaTeX support)

4. **`RetrievalRecallPrecision`** (`retrieval_judge.py:32`)
   - Input: `query`, `system_resource`
   - Output: `score` (0.0-1.0), `reason`

5. **`SuggestionGeneration`** (`suggestion_program.py`)
   - Input: `chat_history`
   - Output: `suggestions` (list of 4-5 follow-up questions)

### DSPy Modules

**Purpose:** Encapsulate program logic with reusable components

1. **`QueryProcessorProgram`** (`query_processor.py:72`)
   - Wraps `dspy.Predict(CairoQueryAnalysis)`
   - Loads optimized program from JSON
   - Validates resources against `DocumentSource` enum

2. **`DocumentRetrieverProgram`** (`document_retriever.py:243`)
   - Wraps `SourceFilteredPgVectorRM`
   - Handles multi-query retrieval and deduplication
   - Enhances with templates based on query type

3. **`GenerationProgram`** (`generation_program.py:157`)
   - Wraps `dspy.ChainOfThought(Signature)`
   - Loads optimized program from JSON
   - Supports streaming via `dspy.streamify()`

4. **`McpGenerationProgram`** (`generation_program.py:289`)
   - No LLM call - formats documents as markdown
   - Used when `mcp_mode=True`

5. **`RagPipeline`** (`rag_pipeline.py:60`)
   - Orchestrates all stages
   - Supports async (`acall`) and streaming (`aforward_streaming`)
   - Tracks LLM usage via `dspy.track_usage()`

6. **`RetrievalJudge`** (`retrieval_judge.py`)
   - Scores and filters retrieved documents
   - Uses fast LLM: `gemini/gemini-flash-lite-latest`

### Core Types

**File:** `python/src/cairo_coder/core/types.py`

1. **`DocumentSource`** (Enum)
   - `CAIRO_BOOK`, `STARKNET_DOCS`, `STARKNET_FOUNDRY`, etc.
   - Used for source filtering in vector store

2. **`ProcessedQuery`** (Dataclass)
   - `original: str`
   - `search_queries: list[str]`
   - `is_contract_related: bool`
   - `is_test_related: bool`
   - `resources: list[DocumentSource]`

3. **`Document`** (Dataclass)
   - `page_content: str`
   - `metadata: dict`
   - Properties: `title`, `source`, `source_link` (extracted from metadata)

4. **`Message`** (Dataclass)
   - `role: Role` ("user" | "assistant" | "system")
   - `content: str`

5. **`PipelineResult`** (Dataclass)
   - `processed_query: ProcessedQuery`
   - `documents: list[Document]`
   - `grok_citations: list[str]`
   - `usage: dict` (token counts)
   - `answer: str`
   - `formatted_sources: list[FormattedSource]`

6. **`StreamEvent`** (Dataclass)
   - `type: StreamEventType` (PROCESSING, SOURCES, REASONING, RESPONSE, FINAL_RESPONSE, ERROR, END)
   - `data: Any`

7. **`FormattedSource`** (TypedDict)
   ```python
   {
       "metadata": {
           "title": str,
           "url": str,
           "source_type": "documentation" | "web_search"
       }
   }
   ```

---

## MCP Mode

**Purpose:** Return raw documentation without LLM generation (for MCP tool integration)

**Activation:** Header `x-mcp-mode: true` or `mcp: true` (line 388, 405, 423 in `app.py`)

**Pipeline Changes:**
1. Skip `GenerationProgram`, use `McpGenerationProgram` instead (line 260-279 in `rag_pipeline.py`)
2. Return formatted documentation as markdown (line 300-331 in `generation_program.py`)
3. No reasoning/answer field in response

**Format:**
```markdown
## 1. Document Title

**Source:** Source Name
**URL:** https://...

{document content}

---

## 2. Next Document Title
...
```

---

## Optimized Programs

**Location:** `python/optimizers/results/`

**Purpose:** Pre-trained prompts optimized via DSPy optimizers (e.g., BootstrapFewShot)

**Files:**
- `optimized_retrieval_program.json` - Query processor prompts
- `optimized_generation_cairo-coder.json` - Cairo Coder generation prompts
- `optimized_generation_starknet-agent.json` - Starknet Agent generation prompts

**Loading:** Programs call `.load(path)` in `__init__()` (query_processor.py:89, generation_program.py:192-195)

**Skipping:** Set `OPTIMIZER_RUN=1` env var to skip loading (for tests/optimizer runs)

---

## Key File Locations

| Component | File | Lines |
|-----------|------|-------|
| **API Server** | `python/src/cairo_coder/server/app.py` | 861 |
| **RAG Pipeline** | `python/src/cairo_coder/core/rag_pipeline.py` | 566 |
| **Query Processor** | `python/src/cairo_coder/dspy/query_processor.py` | 225 |
| **Document Retriever** | `python/src/cairo_coder/dspy/document_retriever.py` | 462 |
| **Generation Program** | `python/src/cairo_coder/dspy/generation_program.py` | 361 |
| **Retrieval Judge** | `python/src/cairo_coder/dspy/retrieval_judge.py` | 380 |
| **Grok Search** | `python/src/cairo_coder/dspy/grok_search.py` | 150 |
| **Agent Registry** | `python/src/cairo_coder/agents/registry.py` | 158 |
| **Agent Factory** | `python/src/cairo_coder/core/agent_factory.py` | 125 |
| **Core Types** | `python/src/cairo_coder/core/types.py` | 300+ |
| **Test Fixtures** | `python/tests/conftest.py` | 627 |
| **Pipeline Tests** | `python/tests/unit/test_rag_pipeline.py` | 30k |
| **Server Integration Tests** | `python/tests/integration/test_server_integration.py` | 31k |

---

## Test Coverage Map

### Unit Tests (Component-level)
| Test File | Component Tested | Key Tests |
|-----------|------------------|-----------|
| `test_query_processor.py` | QueryProcessorProgram | Query analysis, resource identification, search query extraction |
| `test_document_retriever.py` | DocumentRetrieverProgram, SourceFilteredPgVectorRM | Vector search, source filtering, template enhancement |
| `test_generation_program.py` | GenerationProgram, McpGenerationProgram | Code generation, streaming, MCP formatting |
| `test_retrieval_judge.py` | RetrievalJudge | Document scoring, threshold filtering |
| `test_rag_pipeline.py` | RagPipeline | Full pipeline orchestration, async/streaming, MCP mode |
| `test_agent_factory.py` | AgentFactory | Agent creation, caching, registry integration |
| `test_grok_integration.py` | GrokSearchProgram | Web search, citation extraction |
| `test_config.py` | Configuration | Env loading, defaults |
| `test_optimizers_loading.py` | Optimizer artifacts | JSON loading, error handling |

### Integration Tests (End-to-end)
| Test File | Flow Tested | Key Tests |
|-----------|-------------|-----------|
| `test_server_integration.py` | FastAPI → Pipeline → Response | Streaming, multi-turn conversations, MCP mode, error handling, concurrent requests |
| `test_insights_api.py` | Analytics endpoints | Query stats, agent usage, source popularity |
| `test_config_integration.py` | Full config loading | Database connection, vector store setup |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        FastAPI Server                        │
│                  (server/app.py)                             │
│  POST /v1/agents/{id}/chat/completions                       │
│  POST /v1/chat/completions                                   │
│  GET /v1/agents                                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │    AgentFactory        │
        │  (core/agent_factory)  │
        │  • get_or_create_agent │
        │  • cache agents        │
        └────────┬───────────────┘
                 │
                 ▼
    ┌────────────────────────────┐
    │      AgentRegistry         │
    │   (agents/registry)        │
    │  • cairo-coder             │
    │  • starknet-agent          │
    └────────┬───────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│                   RagPipeline                          │
│              (core/rag_pipeline)                       │
│                                                         │
│  Stage 1: Query Processing                             │
│  ┌────────────────────────────────┐                   │
│  │  QueryProcessorProgram         │                   │
│  │  (dspy/query_processor)        │                   │
│  │  • Analyze query               │                   │
│  │  • Extract search queries      │                   │
│  │  • Identify resources          │                   │
│  └────────┬───────────────────────┘                   │
│           │                                             │
│           ▼                                             │
│  Stage 2: Document Retrieval                           │
│  ┌────────────────────────────────┐                   │
│  │  DocumentRetrieverProgram      │                   │
│  │  (dspy/document_retriever)     │                   │
│  │  • Search vector store         │                   │
│  │  • Filter by sources           │                   │
│  │  • Deduplicate documents       │                   │
│  │  • Enhance with templates      │                   │
│  └────────┬───────────────────────┘                   │
│           │                                             │
│           ▼                                             │
│  Stage 2.5: Grok Augmentation (Optional)              │
│  ┌────────────────────────────────┐                   │
│  │  GrokSearchProgram             │                   │
│  │  (dspy/grok_search)            │                   │
│  │  • Fetch web/X posts           │                   │
│  │  • Add virtual summary doc     │                   │
│  └────────┬───────────────────────┘                   │
│           │                                             │
│           ▼                                             │
│  Stage 2.6: Retrieval Judging                         │
│  ┌────────────────────────────────┐                   │
│  │  RetrievalJudge                │                   │
│  │  (dspy/retrieval_judge)        │                   │
│  │  • Score documents (0.0-1.0)   │                   │
│  │  • Filter by threshold (0.4)   │                   │
│  └────────┬───────────────────────┘                   │
│           │                                             │
│           ▼                                             │
│  Stage 3: Generation                                   │
│  ┌────────────────────────────────┐                   │
│  │  GenerationProgram             │                   │
│  │  (dspy/generation_program)     │                   │
│  │  • Chain of Thought reasoning  │                   │
│  │  • Stream response chunks      │                   │
│  │  OR                             │                   │
│  │  McpGenerationProgram          │                   │
│  │  • Format raw documentation    │                   │
│  └────────┬───────────────────────┘                   │
└───────────┼────────────────────────────────────────────┘
            │
            ▼
┌────────────────────────────────┐
│     Response Assembly          │
│  • PipelineResult with usage   │
│  • FormattedSource list        │
│  • Grok citations              │
└────────────────────────────────┘
```

---

## Conventions Discovered

### Naming
- **Files:** snake_case (`rag_pipeline.py`, `query_processor.py`)
- **Classes:** PascalCase (`RagPipeline`, `DocumentRetrieverProgram`)
- **Functions:** snake_case (`aforward`, `get_or_create_agent`)
- **Constants:** UPPER_SNAKE_CASE (`MAX_SOURCE_COUNT`, `SIMILARITY_THRESHOLD`)

### DSPy Patterns
- **Signatures:** Define input/output schema with type hints and `InputField`/`OutputField` descriptors
- **Modules:** Wrap `dspy.Predict` or `dspy.ChainOfThought` with business logic
- **Async:** All forward methods have async variants (`aforward`, `acall`)
- **Streaming:** Use `dspy.streamify()` to wrap programs for streaming
- **Optimizers:** Load pre-trained prompts via `.load(json_path)`

### Testing
- **Fixtures:** All shared fixtures in `tests/conftest.py` (enforced by CLAUDE.md)
- **Mocking:** Unit tests mock all external dependencies (LLM, vector DB)
- **Integration:** Use `TestClient` with dependency injection
- **Database:** Ephemeral PostgreSQL via testcontainers (Docker)
- **Auto-fixtures:** `optimizer_artifacts_optional`, `enable_dspy_track_usage`, `clean_config_env_vars`

### Error Handling
- **Retry Logic:** `AdapterParseError` retries 3 times with fallback code extraction (generation_program.py:216-222)
- **Streaming Errors:** Emit `StreamEventType.ERROR` event (rag_pipeline.py:357-358)
- **API Errors:** Global exception handlers for `ValueError` (400) and `Exception` (500) (app.py:293-325)

---

## Open Questions

1. **Optimizer Artifacts:** How are optimized programs generated? What training data is used?
2. **Grok Search:** What is the Grok API key/endpoint? How often is it called?
3. **Retrieval Judge Threshold:** Why 0.4? Was this empirically tuned?
4. **Agent Caching:** Should caching strategy differ between agents? (Currently caches forever)
5. **Token Tracking:** Are token limits enforced? What happens on token overflow?
6. **Database Migrations:** How are schema changes handled for `UserInteraction` table?
7. **Embedding Model:** Gemini embeddings (3072 dims) - why this model? Cost/performance tradeoffs?

---

## Summary Table: DSPy Modules

| Module | File | Signature | Input | Output | Optimized? |
|--------|------|-----------|-------|--------|------------|
| QueryProcessorProgram | query_processor.py | CairoQueryAnalysis | query, chat_history | search_queries, resources | ✓ (optimized_retrieval_program.json) |
| DocumentRetrieverProgram | document_retriever.py | N/A (vector search) | processed_query, sources | documents | ✗ |
| RetrievalJudge | retrieval_judge.py | RetrievalRecallPrecision | query, system_resource | score, reason | ✗ |
| GrokSearchProgram | grok_search.py | N/A (API call) | query, chat_history | documents, citations | ✗ |
| GenerationProgram | generation_program.py | CairoCodeGeneration / StarknetEcosystemGeneration | query, context, chat_history | answer | ✓ (optimized_generation_{agent_id}.json) |
| McpGenerationProgram | generation_program.py | N/A (formatting) | documents | answer (formatted markdown) | ✗ |
| RagPipeline | rag_pipeline.py | N/A (orchestration) | query, chat_history, mcp_mode | answer, documents, usage | ✗ |

---

**Report Complete.** All key abstractions, file locations, and test structures documented.
